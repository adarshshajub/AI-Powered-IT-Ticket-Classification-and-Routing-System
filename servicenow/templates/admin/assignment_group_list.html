{% extends "base.html" %}
{% load widget_tweaks %}
{% block title %}Assignment Groups{% endblock %}

{% block content %}
  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags }} alert-dismissible fade show">
        {{ m }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div>
    <h3 class="mb-3">Assignment Groups</h3>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <small class="text-muted">
        You logged in as user - {{ request.user.username }}
        {% if user.is_superuser %}
          (Superuser)
        {% elif user.is_active %}
          (Staff)
        {% endif %}
      </small>
      <a href="{% url 'servicenow:assignment_group_create' %}"
         class="btn btn-primary btn-sm">+ Add Group</a>
    </div>

    <div class="d-flex justify-content-center">
      <div class="card-compact p-4" style="max-width: 1500px; width: 100%;">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Name</th>
              <th>ServiceNow Group ID</th>
              <th>Category</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for g in groups %}
              <tr>
                <td>{{ g.name }}</td>
                <td>{{ g.servicenow_group_id }}</td>
                <td>{{ g.category|default:"â€”" }}</td>
                <td>
                  {% if g.is_active %}
                    <span class="badge bg-success">Active</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a href="{% url 'servicenow:assignment_group_update' g.id %}"
                     class="btn btn-sm btn-outline-secondary">Edit</a>
                  {% if user.is_superuser %}
                  <button type="button"
                          class="btn btn-sm btn-outline-danger ag-open-delete-modal"
                          data-group-id="{{ g.id }}"
                          data-group-name="{{ g.name }}">
                    Delete
                  </button>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5">No assignment groups found.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Overlay + modal -->
  <div id="ag-delete-overlay" class="ag-delete-overlay ag-d-none"></div>

  <div id="ag-delete-modal" class="ag-delete-modal ag-d-none">
    <div class="ag-delete-modal-content">
      <h5 class="mb-3">Confirm delete</h5>
      <p id="ag-delete-text">Are you sure you want to delete this group?</p>
      <form id="ag-delete-form" method="post">
        {% csrf_token %}
        <div class="mt-4 d-flex justify-content-end ag-gap-2">
          <button type="button" class="btn btn-secondary btn-sm" id="ag-cancel-delete">
            Cancel
          </button>
          <button type="submit" class="btn btn-danger btn-sm">
            Delete
          </button>
        </div>
      </form>
    </div>
  </div>

  <style>
    body.ag-modal-open {
      overflow: hidden;
    }

    /* Overlay below navbar (.topbar has z-index:1000 in base.html) */
    .ag-delete-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(2px);
      z-index: 900;
    }

    /* Modal above everything */
    .ag-delete-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .ag-delete-modal-content {
      background: #ffffff;
      padding: 24px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .ag-d-none {
      display: none !important;
    }

    .ag-gap-2 {
      gap: 0.5rem;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const modal = document.getElementById('ag-delete-modal');
      const overlay = document.getElementById('ag-delete-overlay');
      const deleteText = document.getElementById('ag-delete-text');
      const deleteForm = document.getElementById('ag-delete-form');
      const cancelBtn = document.getElementById('ag-cancel-delete');

      function openModal(groupId, groupName) {
        deleteText.textContent = `Are you sure you want to delete group "${groupName}"?`;
        // Use dummy id 0 in URL and replace with real id
        deleteForm.action = `{% url 'servicenow:assignment_group_delete' 0 %}`.replace('/0/', `/${groupId}/`);
        modal.classList.remove('ag-d-none');
        overlay.classList.remove('ag-d-none');
        document.body.classList.add('ag-modal-open');
      }

      function closeModal() {
        modal.classList.add('ag-d-none');
        overlay.classList.add('ag-d-none');
        document.body.classList.remove('ag-modal-open');
      }

      document.querySelectorAll('.ag-open-delete-modal').forEach(btn => {
        btn.addEventListener('click', function () {
          openModal(this.dataset.groupId, this.dataset.groupName);
        });
      });

      cancelBtn.addEventListener('click', closeModal);
      overlay.addEventListener('click', closeModal);

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    });
  </script>
{% endblock %}
